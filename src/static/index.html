<html>
  <head>
    <meta charset="utf-8">
    <meta name="referrer" content="always" />
    <link media="all" rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css" >
    <link media="all" rel="stylesheet" href="stylesheets/react.css" >
    <script src="//d3js.org/d3.v4.min.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <style>
</style>
  </head>
  <body>
    <div id="app">
      <?xml version="1.0" encoding="UTF-8"?>
<svg class="chart" width="875" height="560"></svg>
    </div>
    <script >
      const m = moment()

      const thirtyDaysAgo = m.format('YYYY-MM-DD')
      const sixtyDaysAgo = m.add(-30, 'days').format('YYYY-MM-DD')

      const apiPrefix = readApiPrefix()

      const thisMonth = `${apiPrefix}/1/user/-/activities/heart/date/${thirtyDaysAgo}/30d.json`
      const lastMonth = `${apiPrefix}/1/user/-/activities/heart/date/${sixtyDaysAgo}/30d.json`

      const thisMonthP = window.fetch(thisMonth, {credentials: 'include'}).then(r => r.json())
      const lastMonthP = window.fetch(lastMonth, {credentials: 'include'}).then(r => r.json())
      //const thisMonthP = Promise.resolve({"activities-heart":[{"dateTime":"2017-03-02","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":285.549,"max":92,"min":30,"minutes":260,"name":"Out of Range"},{"caloriesOut":928.5485,"max":129,"min":92,"minutes":456,"name":"Fat Burn"},{"caloriesOut":69.003,"max":157,"min":129,"minutes":11,"name":"Cardio"},{"caloriesOut":10.0045,"max":220,"min":157,"minutes":1,"name":"Peak"}],"restingHeartRate":82}},{"dateTime":"2017-03-03","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":364.089,"max":92,"min":30,"minutes":320,"name":"Out of Range"},{"caloriesOut":552.024,"max":129,"min":92,"minutes":234,"name":"Fat Burn"},{"caloriesOut":12.716,"max":157,"min":129,"minutes":2,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":80}},{"dateTime":"2017-03-04","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":13.464,"max":92,"min":30,"minutes":9,"name":"Out of Range"},{"caloriesOut":94.996,"max":129,"min":92,"minutes":19,"name":"Fat Burn"},{"caloriesOut":0,"max":157,"min":129,"minutes":0,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}]}},{"dateTime":"2017-03-05","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":159.885,"max":92,"min":30,"minutes":97,"name":"Out of Range"},{"caloriesOut":609.62,"max":129,"min":92,"minutes":178,"name":"Fat Burn"},{"caloriesOut":81.2515,"max":157,"min":129,"minutes":14,"name":"Cardio"},{"caloriesOut":18.6065,"max":220,"min":157,"minutes":2,"name":"Peak"}],"restingHeartRate":80}},{"dateTime":"2017-03-06","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":12.4355,"max":92,"min":30,"minutes":13,"name":"Out of Range"},{"caloriesOut":307.802,"max":129,"min":92,"minutes":73,"name":"Fat Burn"},{"caloriesOut":42.075,"max":157,"min":129,"minutes":6,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}]}},{"dateTime":"2017-03-07","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":396.44,"max":92,"min":30,"minutes":287,"name":"Out of Range"},{"caloriesOut":777.172,"max":129,"min":92,"minutes":278,"name":"Fat Burn"},{"caloriesOut":10.0045,"max":157,"min":129,"minutes":2,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":79}},{"dateTime":"2017-03-08","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":441.7875,"max":92,"min":30,"minutes":385,"name":"Out of Range"},{"caloriesOut":707.982,"max":129,"min":92,"minutes":237,"name":"Fat Burn"},{"caloriesOut":40.766,"max":157,"min":129,"minutes":6,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":79}},{"dateTime":"2017-03-09","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":381.1995,"max":92,"min":30,"minutes":334,"name":"Out of Range"},{"caloriesOut":880.957,"max":129,"min":92,"minutes":360,"name":"Fat Burn"},{"caloriesOut":123.3265,"max":157,"min":129,"minutes":18,"name":"Cardio"},{"caloriesOut":42.823,"max":220,"min":157,"minutes":4,"name":"Peak"}],"restingHeartRate":79}},{"dateTime":"2017-03-10","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":431.783,"max":92,"min":30,"minutes":370,"name":"Out of Range"},{"caloriesOut":519.2055,"max":129,"min":92,"minutes":164,"name":"Fat Burn"},{"caloriesOut":0,"max":157,"min":129,"minutes":0,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":78}},{"dateTime":"2017-03-11","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":13.5575,"max":92,"min":30,"minutes":11,"name":"Out of Range"},{"caloriesOut":250.019,"max":129,"min":92,"minutes":54,"name":"Fat Burn"},{"caloriesOut":7.106,"max":157,"min":129,"minutes":1,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}]}},{"dateTime":"2017-03-12","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":271.337,"max":92,"min":30,"minutes":171,"name":"Out of Range"},{"caloriesOut":519.3925,"max":129,"min":92,"minutes":154,"name":"Fat Burn"},{"caloriesOut":70.7795,"max":157,"min":129,"minutes":13,"name":"Cardio"},{"caloriesOut":21.505,"max":220,"min":157,"minutes":2,"name":"Peak"}],"restingHeartRate":77}},{"dateTime":"2017-03-13","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":585.871,"max":92,"min":30,"minutes":503,"name":"Out of Range"},{"caloriesOut":486.574,"max":129,"min":92,"minutes":180,"name":"Fat Burn"},{"caloriesOut":45.441,"max":157,"min":129,"minutes":6,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":77}},{"dateTime":"2017-03-14","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":283.2115,"max":92,"min":30,"minutes":245,"name":"Out of Range"},{"caloriesOut":460.02,"max":129,"min":92,"minutes":142,"name":"Fat Burn"},{"caloriesOut":24.684,"max":157,"min":129,"minutes":4,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":77}},{"dateTime":"2017-03-15","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":333.608,"max":92,"min":30,"minutes":293,"name":"Out of Range"},{"caloriesOut":788.205,"max":129,"min":92,"minutes":396,"name":"Fat Burn"},{"caloriesOut":38.148,"max":157,"min":129,"minutes":5,"name":"Cardio"},{"caloriesOut":10.659,"max":220,"min":157,"minutes":1,"name":"Peak"}],"restingHeartRate":77}},{"dateTime":"2017-03-16","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":362.3125,"max":92,"min":30,"minutes":295,"name":"Out of Range"},{"caloriesOut":896.9455,"max":129,"min":92,"minutes":402,"name":"Fat Burn"},{"caloriesOut":107.899,"max":157,"min":129,"minutes":15,"name":"Cardio"},{"caloriesOut":9.35,"max":220,"min":157,"minutes":1,"name":"Peak"}],"restingHeartRate":78}},{"dateTime":"2017-03-17","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":0,"max":92,"min":30,"minutes":0,"name":"Out of Range"},{"caloriesOut":11.407,"max":129,"min":92,"minutes":3,"name":"Fat Burn"},{"caloriesOut":5.984,"max":157,"min":129,"minutes":1,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}]}},{"dateTime":"2017-03-18","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":371.4755,"max":92,"min":30,"minutes":342,"name":"Out of Range"},{"caloriesOut":486.2935,"max":129,"min":92,"minutes":147,"name":"Fat Burn"},{"caloriesOut":101.4475,"max":157,"min":129,"minutes":13,"name":"Cardio"},{"caloriesOut":44.693,"max":220,"min":157,"minutes":4,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-03-19","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":183.9145,"max":92,"min":30,"minutes":167,"name":"Out of Range"},{"caloriesOut":548.5645,"max":129,"min":92,"minutes":195,"name":"Fat Burn"},{"caloriesOut":19.822,"max":157,"min":129,"minutes":3,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":77}},{"dateTime":"2017-03-20","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":525.7505,"max":92,"min":30,"minutes":451,"name":"Out of Range"},{"caloriesOut":631.0315,"max":129,"min":92,"minutes":334,"name":"Fat Burn"},{"caloriesOut":27.9565,"max":157,"min":129,"minutes":4,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":77}},{"dateTime":"2017-03-21","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":696.762,"max":92,"min":30,"minutes":632,"name":"Out of Range"},{"caloriesOut":267.036,"max":129,"min":92,"minutes":101,"name":"Fat Burn"},{"caloriesOut":0,"max":157,"min":129,"minutes":0,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":75}},{"dateTime":"2017-03-22","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":491.5295,"max":92,"min":30,"minutes":432,"name":"Out of Range"},{"caloriesOut":663.102,"max":129,"min":92,"minutes":258,"name":"Fat Burn"},{"caloriesOut":11.594,"max":157,"min":129,"minutes":2,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":75}},{"dateTime":"2017-03-23","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":282.6505,"max":92,"min":30,"minutes":250,"name":"Out of Range"},{"caloriesOut":840.0975,"max":129,"min":92,"minutes":384,"name":"Fat Burn"},{"caloriesOut":55.2585,"max":157,"min":129,"minutes":8,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-03-24","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":160.9135,"max":92,"min":30,"minutes":141,"name":"Out of Range"},{"caloriesOut":690.591,"max":129,"min":92,"minutes":258,"name":"Fat Burn"},{"caloriesOut":77.1375,"max":157,"min":129,"minutes":10,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":75}},{"dateTime":"2017-03-25","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":198.1265,"max":92,"min":30,"minutes":175,"name":"Out of Range"},{"caloriesOut":1032.988,"max":129,"min":92,"minutes":374,"name":"Fat Burn"},{"caloriesOut":57.3155,"max":157,"min":129,"minutes":8,"name":"Cardio"},{"caloriesOut":9.911,"max":220,"min":157,"minutes":1,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-03-26","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":229.1685,"max":92,"min":30,"minutes":141,"name":"Out of Range"},{"caloriesOut":619.0635,"max":129,"min":92,"minutes":194,"name":"Fat Burn"},{"caloriesOut":113.2285,"max":157,"min":129,"minutes":19,"name":"Cardio"},{"caloriesOut":40.766,"max":220,"min":157,"minutes":4,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-03-27","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":460.1135,"max":92,"min":30,"minutes":404,"name":"Out of Range"},{"caloriesOut":644.4955,"max":129,"min":92,"minutes":229,"name":"Fat Burn"},{"caloriesOut":11.594,"max":157,"min":129,"minutes":2,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-03-28","value":{"customHeartRateZones":[],"heartRateZones":[{"max":92,"min":30,"name":"Out of Range"},{"max":129,"min":92,"name":"Fat Burn"},{"max":157,"min":129,"name":"Cardio"},{"max":220,"min":157,"name":"Peak"}]}},{"dateTime":"2017-03-29","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":399.5255,"max":92,"min":30,"minutes":334,"name":"Out of Range"},{"caloriesOut":713.1245,"max":129,"min":92,"minutes":271,"name":"Fat Burn"},{"caloriesOut":34.221,"max":157,"min":129,"minutes":5,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-03-30","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":407.5665,"max":92,"min":30,"minutes":375,"name":"Out of Range"},{"caloriesOut":1012.1375,"max":129,"min":92,"minutes":364,"name":"Fat Burn"},{"caloriesOut":28.798,"max":157,"min":129,"minutes":4,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-03-31","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":292.0005,"max":92,"min":30,"minutes":284,"name":"Out of Range"},{"caloriesOut":323.323,"max":129,"min":92,"minutes":148,"name":"Fat Burn"},{"caloriesOut":83.6825,"max":157,"min":129,"minutes":12,"name":"Cardio"},{"caloriesOut":9.537,"max":220,"min":157,"minutes":1,"name":"Peak"}],"restingHeartRate":76}}]})
      //const lastMonthP = Promise.resolve({"activities-heart":[{"dateTime":"2017-04-01","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":555.6705,"max":92,"min":30,"minutes":497,"name":"Out of Range"},{"caloriesOut":230.945,"max":129,"min":92,"minutes":77,"name":"Fat Burn"},{"caloriesOut":0,"max":157,"min":129,"minutes":0,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":75}},{"dateTime":"2017-04-02","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":158.576,"max":92,"min":30,"minutes":128,"name":"Out of Range"},{"caloriesOut":634.7715,"max":129,"min":92,"minutes":164,"name":"Fat Burn"},{"caloriesOut":88.638,"max":157,"min":129,"minutes":12,"name":"Cardio"},{"caloriesOut":9.35,"max":220,"min":157,"minutes":1,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-04-03","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":208.879,"max":92,"min":30,"minutes":177,"name":"Out of Range"},{"caloriesOut":732.666,"max":129,"min":92,"minutes":239,"name":"Fat Burn"},{"caloriesOut":65.076,"max":157,"min":129,"minutes":9,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":75}},{"dateTime":"2017-04-04","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":211.684,"max":92,"min":30,"minutes":167,"name":"Out of Range"},{"caloriesOut":1071.4165,"max":129,"min":92,"minutes":373,"name":"Fat Burn"},{"caloriesOut":104.72,"max":157,"min":129,"minutes":15,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-04-05","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":311.0745,"max":92,"min":30,"minutes":282,"name":"Out of Range"},{"caloriesOut":803.165,"max":129,"min":92,"minutes":358,"name":"Fat Burn"},{"caloriesOut":73.304,"max":157,"min":129,"minutes":10,"name":"Cardio"},{"caloriesOut":44.506,"max":220,"min":157,"minutes":5,"name":"Peak"}],"restingHeartRate":78}},{"dateTime":"2017-04-06","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":644.589,"max":92,"min":30,"minutes":602,"name":"Out of Range"},{"caloriesOut":1066.7415,"max":129,"min":92,"minutes":513,"name":"Fat Burn"},{"caloriesOut":30.7615,"max":157,"min":129,"minutes":5,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":79}},{"dateTime":"2017-04-07","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":319.77,"max":92,"min":30,"minutes":299,"name":"Out of Range"},{"caloriesOut":973.6155,"max":129,"min":92,"minutes":357,"name":"Fat Burn"},{"caloriesOut":209.627,"max":157,"min":129,"minutes":28,"name":"Cardio"},{"caloriesOut":39.644,"max":220,"min":157,"minutes":4,"name":"Peak"}],"restingHeartRate":79}},{"dateTime":"2017-04-08","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":470.679,"max":92,"min":30,"minutes":459,"name":"Out of Range"},{"caloriesOut":955.757,"max":129,"min":92,"minutes":271,"name":"Fat Burn"},{"caloriesOut":110.891,"max":157,"min":129,"minutes":15,"name":"Cardio"},{"caloriesOut":19.261,"max":220,"min":157,"minutes":2,"name":"Peak"}],"restingHeartRate":78}},{"dateTime":"2017-04-09","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":343.9865,"max":92,"min":30,"minutes":289,"name":"Out of Range"},{"caloriesOut":1088.6205,"max":129,"min":92,"minutes":347,"name":"Fat Burn"},{"caloriesOut":127.721,"max":157,"min":129,"minutes":19,"name":"Cardio"},{"caloriesOut":51.238,"max":220,"min":157,"minutes":5,"name":"Peak"}],"restingHeartRate":78}},{"dateTime":"2017-04-10","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":505.087,"max":92,"min":30,"minutes":443,"name":"Out of Range"},{"caloriesOut":572.1265,"max":129,"min":92,"minutes":168,"name":"Fat Burn"},{"caloriesOut":61.6165,"max":157,"min":129,"minutes":8,"name":"Cardio"},{"caloriesOut":9.911,"max":220,"min":157,"minutes":1,"name":"Peak"}],"restingHeartRate":77}},{"dateTime":"2017-04-11","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":326.315,"max":92,"min":30,"minutes":298,"name":"Out of Range"},{"caloriesOut":901.153,"max":129,"min":92,"minutes":370,"name":"Fat Burn"},{"caloriesOut":246.279,"max":157,"min":129,"minutes":34,"name":"Cardio"},{"caloriesOut":59.092,"max":220,"min":157,"minutes":6,"name":"Peak"}],"restingHeartRate":78}},{"dateTime":"2017-04-12","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":445.9015,"max":92,"min":30,"minutes":389,"name":"Out of Range"},{"caloriesOut":608.2175,"max":129,"min":92,"minutes":193,"name":"Fat Burn"},{"caloriesOut":30.294,"max":157,"min":129,"minutes":4,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":77}},{"dateTime":"2017-04-13","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":392.887,"max":92,"min":30,"minutes":349,"name":"Out of Range"},{"caloriesOut":680.493,"max":129,"min":92,"minutes":258,"name":"Fat Burn"},{"caloriesOut":53.5755,"max":157,"min":129,"minutes":7,"name":"Cardio"},{"caloriesOut":32.538,"max":220,"min":157,"minutes":3,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-04-14","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":525.7505,"max":92,"min":30,"minutes":497,"name":"Out of Range"},{"caloriesOut":443.2835,"max":129,"min":92,"minutes":174,"name":"Fat Burn"},{"caloriesOut":40.766,"max":157,"min":129,"minutes":6,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":76}},{"dateTime":"2017-04-15","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":553.707,"max":92,"min":30,"minutes":496,"name":"Out of Range"},{"caloriesOut":358.853,"max":129,"min":92,"minutes":141,"name":"Fat Burn"},{"caloriesOut":13.838,"max":157,"min":129,"minutes":2,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":75}},{"dateTime":"2017-04-16","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":653.004,"max":92,"min":30,"minutes":620,"name":"Out of Range"},{"caloriesOut":211.123,"max":129,"min":92,"minutes":81,"name":"Fat Burn"},{"caloriesOut":0,"max":157,"min":129,"minutes":0,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":74}},{"dateTime":"2017-04-17","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":490.314,"max":92,"min":30,"minutes":497,"name":"Out of Range"},{"caloriesOut":11.22,"max":129,"min":92,"minutes":7,"name":"Fat Burn"},{"caloriesOut":0,"max":157,"min":129,"minutes":0,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":72}},{"dateTime":"2017-04-18","value":{"customHeartRateZones":[],"heartRateZones":[{"max":92,"min":30,"name":"Out of Range"},{"max":129,"min":92,"name":"Fat Burn"},{"max":157,"min":129,"name":"Cardio"},{"max":220,"min":157,"name":"Peak"}]}},{"dateTime":"2017-04-19","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":590.8265,"max":92,"min":30,"minutes":504,"name":"Out of Range"},{"caloriesOut":783.6235,"max":129,"min":92,"minutes":296,"name":"Fat Burn"},{"caloriesOut":34.408,"max":157,"min":129,"minutes":4,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":72}},{"dateTime":"2017-04-20","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":48.9005,"max":92,"min":30,"minutes":47,"name":"Out of Range"},{"caloriesOut":21.692,"max":129,"min":92,"minutes":12,"name":"Fat Burn"},{"caloriesOut":0,"max":157,"min":129,"minutes":0,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}]}},{"dateTime":"2017-04-21","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":757.537,"max":92,"min":30,"minutes":617,"name":"Out of Range"},{"caloriesOut":855.8055,"max":129,"min":92,"minutes":268,"name":"Fat Burn"},{"caloriesOut":0,"max":157,"min":129,"minutes":0,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":71}},{"dateTime":"2017-04-22","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":467.5,"max":92,"min":30,"minutes":396,"name":"Out of Range"},{"caloriesOut":455.0645,"max":129,"min":92,"minutes":130,"name":"Fat Burn"},{"caloriesOut":72.369,"max":157,"min":129,"minutes":9,"name":"Cardio"},{"caloriesOut":31.416,"max":220,"min":157,"minutes":3,"name":"Peak"}],"restingHeartRate":71}},{"dateTime":"2017-04-23","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":453.7555,"max":92,"min":30,"minutes":339,"name":"Out of Range"},{"caloriesOut":421.0305,"max":129,"min":92,"minutes":132,"name":"Fat Burn"},{"caloriesOut":14.96,"max":157,"min":129,"minutes":2,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":70}},{"dateTime":"2017-04-24","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":414.018,"max":92,"min":30,"minutes":377,"name":"Out of Range"},{"caloriesOut":341.3685,"max":129,"min":92,"minutes":95,"name":"Fat Burn"},{"caloriesOut":0,"max":157,"min":129,"minutes":0,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":71}},{"dateTime":"2017-04-25","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":402.5175,"max":92,"min":30,"minutes":309,"name":"Out of Range"},{"caloriesOut":1255.705,"max":129,"min":92,"minutes":413,"name":"Fat Burn"},{"caloriesOut":149.974,"max":157,"min":129,"minutes":21,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":72}},{"dateTime":"2017-04-26","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":504.4325,"max":92,"min":30,"minutes":438,"name":"Out of Range"},{"caloriesOut":841.7805,"max":129,"min":92,"minutes":268,"name":"Fat Burn"},{"caloriesOut":59.653,"max":157,"min":129,"minutes":8,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":73}},{"dateTime":"2017-04-27","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":1024.386,"max":92,"min":30,"minutes":957,"name":"Out of Range"},{"caloriesOut":499.477,"max":129,"min":92,"minutes":140,"name":"Fat Burn"},{"caloriesOut":15.147,"max":157,"min":129,"minutes":2,"name":"Cardio"},{"caloriesOut":0,"max":220,"min":157,"minutes":0,"name":"Peak"}],"restingHeartRate":72}},{"dateTime":"2017-04-28","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":665.8135,"max":92,"min":30,"minutes":566,"name":"Out of Range"},{"caloriesOut":827.5685,"max":129,"min":92,"minutes":256,"name":"Fat Burn"},{"caloriesOut":135.4815,"max":157,"min":129,"minutes":17,"name":"Cardio"},{"caloriesOut":10.1915,"max":220,"min":157,"minutes":1,"name":"Peak"}],"restingHeartRate":72}},{"dateTime":"2017-04-29","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":520.982,"max":92,"min":30,"minutes":410,"name":"Out of Range"},{"caloriesOut":737.2475,"max":129,"min":92,"minutes":174,"name":"Fat Burn"},{"caloriesOut":7.854,"max":157,"min":129,"minutes":1,"name":"Cardio"},{"caloriesOut":33.286,"max":220,"min":157,"minutes":3,"name":"Peak"}],"restingHeartRate":72}},{"dateTime":"2017-04-30","value":{"customHeartRateZones":[],"heartRateZones":[{"caloriesOut":179.4265,"max":92,"min":30,"minutes":120,"name":"Out of Range"},{"caloriesOut":368.39,"max":129,"min":92,"minutes":120,"name":"Fat Burn"},{"caloriesOut":184.756,"max":157,"min":129,"minutes":28,"name":"Cardio"},{"caloriesOut":135.201,"max":220,"min":157,"minutes":12,"name":"Peak"}],"restingHeartRate":73}}]})

      Promise.all([thisMonthP, lastMonthP])
        .then(([thisMonthRawData, lastMonthRawData]) => {


          const rawData = lastMonthRawData['activities-heart'].concat(thisMonthRawData['activities-heart'])

          drawGraph(rawData.map(x => ({date: d3.isoParse(x.dateTime), weight: +x.value.restingHeartRate})))
        })

      // thisMonthP.then(thisMonthRawData => {
      //   return new Promise((resolve, reject) => {
      //     let rawData, allData
      //     rawData = allData = thisMonthRawData['activities-heart']
      //       console.log('thisMonthRawData:', thisMonthRawData)

      //       // if (rawData.all(x => !x.value || !x.value.restingHeartRate)) {
      //       //   return resolve(allData)
      //       // }

      //       lastMonthP.then(lastMonthRawData => {
      //         allData = allData.concat(lastMonthRawData['activities-heart'])
      //         resolve(allData)
      //       })

      //     })
      // })
      // .then(rawData => {
      //   // console.log('thisMonthRawData:', thisMonthRawData['activities-heart'].map(x => x.dateTime+'=>'+x.value.restingHeartRate))
      //   // console.log('lastMonthRawData:', lastMonthRawData['activities-heart'].map(x => x.dateTime+'=>'+x.value.restingHeartRate))
      //   console.log('rawData:', rawData.map(x => x.dateTime+'=>'+x.value.restingHeartRate))
      //   drawGraph(rawData.map(x => ({date: d3.isoParse(x.dateTime), weight: +x.value.restingHeartRate})))
      // })

      function drawGraph (data) {
        // const dateToWeight = rawData.reduce((p, c) => {
        //   p[c.date] = c.weight;
        //   return p
        // }, {})
        // var parseTime = d3.isoParse
        // const data = Object.keys(dateToWeight).map(k => ({date: parseTime(k), weight: dateToWeight[k]}))
        data.sort((a, b) => a.date - b.date)

        for(let i=0; i<data.length; i++) {
          let start = i-30
          if (start < 0) start = 0
          let size = (i - start) + 1
          let values = [], weightings = []
          let weightingF = 1 / (size + 1)
          let weighting = weightingF
          console.log('weighting:',weighting)
          for(let s=start; s<=i; s++) {
            if (data[s].weight) {
              values.push(data[s].weight * weighting)
              weightings.push(weighting)
            } else {
              if (s>0) data[s].weight = data[s-1].weight
            }
            weighting += weightingF
          }

          let sumValues = values.reduce((p, c) => p + c, 0)
          let sumWeightings = weightings.reduce((p, c) => p + c, 0)
          console.log('sumValues:', sumValues)
          console.log('sumWeightings:', sumWeightings)

          data[i].average = sumValues / sumWeightings
        }
        console.log('data:', data)
        // data.splice(0, 30)
        // const data = Object.keys(dateToWeight).map(k => dateToWeight[k])

        var svg = d3.select(".chart"),
            margin = {top: 20, right: 20, bottom: 30, left: 50},
            width = +svg.attr("width") - margin.left - margin.right,
            height = +svg.attr("height") - margin.top - margin.bottom,
            g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


        var x = d3.scaleTime()
            .rangeRound([0, width]);

        var y = d3.scaleLinear()
            .rangeRound([height, 0]);

        var lineA = d3.line()
            .x(d => x(d.date))
            .y(d => y(d.weight))

        var lineB = d3.line()
            .curve(d3.curveBasis)
            .x(d => x(d.date))
            .y(d => y(d.average))

        x.domain(d3.extent(data, function(d) { return d.date; }));
        y.domain(d3.extent(data, function(d) { return d.weight; }));

        g.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x))

        g.append("g")
          .call(d3.axisLeft(y))
          .append("text")
            .attr("fill", "#000")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "0.71em")
            .attr("text-anchor", "end")
            .text("Average Heart Rate (bpm)");

        g.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-linejoin", "round")
            .attr("stroke-linecap", "round")
            .attr("stroke-width", 1.5)
            .attr("d", lineA);

        g.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "red")
            .attr("stroke-linejoin", "round")
            .attr("stroke-linecap", "round")
            .attr("stroke-width", 2)
            .attr("d", lineB);
      }

    function readApiPrefix () {
      if (window.location.hostname.endsWith('dev')) {
        return 'https://api-fitbit-com.auth.codeite.dev'
      } else if (window.location.hostname.endsWith('net')) {
        return 'https://api-fitbit-com.auth.codeite.net'
      }
    }

    </script>
  </body>
</html>